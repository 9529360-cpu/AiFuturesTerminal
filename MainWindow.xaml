<Window x:Class="AiFuturesTerminal.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AiFuturesTerminal"
        xmlns:strategy="clr-namespace:AiFuturesTerminal.Core.Strategy"
        xmlns:conv="clr-namespace:AiFuturesTerminal.UI.Converters;assembly=AiFuturesTerminal"
        mc:Ignorable="d"
        Title="AiFuturesTerminal" Height="600" Width="900">

    <Window.Resources>
        <!-- Converters are registered at runtime in App.OnStartup to avoid XAML type resolution issues at compile time -->
        <Style x:Key="RightAlignCellStyle" TargetType="TextBlock">
            <Setter Property="TextAlignment" Value="Right" />
            <Setter Property="Margin" Value="4,0,4,0" />
        </Style>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    </Window.Resources>

    <DockPanel Margin="12">
        <StatusBar DockPanel.Dock="Bottom">
            <StatusBarItem>
                <TextBlock Text="{Binding EnvironmentDisplay}" />
            </StatusBarItem>

            <StatusBarItem>
                <TextBlock Text="{Binding ExecutionModeDisplay}" Margin="16,0,0,0" />
            </StatusBarItem>

            <StatusBarItem>
                <TextBlock Text="{Binding StatusText}" Margin="16,0,0,0" />
            </StatusBarItem>
            <StatusBarItem>
                <TextBlock Text="{Binding TradeBookWriteStatus}" Margin="16,0,0,0" />
            </StatusBarItem>
        </StatusBar>

        <Grid Margin="8">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="2*" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <!-- Row 0: control area (strategy + buttons) -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="8" VerticalAlignment="Center">
                <!-- 当前策略下拉 -->
                <TextBlock Text="当前策略：" VerticalAlignment="Center" Margin="0,0,8,0" />
                <ComboBox Width="140"
                          ItemsSource="{Binding AvailableStrategyKinds}"
                          SelectedItem="{Binding SelectedStrategyKind, Mode=TwoWay}"
                          Margin="0,0,16,0">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Converter={StaticResource StrategyKindToDisplayConverter}}" />
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <!-- 新增：执行模式 -->
                <TextBlock Text="执行模式：" VerticalAlignment="Center" Margin="0,0,8,0" />
                <ComboBox Width="180"
                          ItemsSource="{Binding AvailableExecutionModes}"
                          SelectedItem="{Binding SelectedExecutionMode, Mode=TwoWay}"
                          Margin="0,0,16,0">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding Converter={StaticResource ExecutionModeToDisplayConverter}}" />
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>

                <!-- 已有按钮 -->
                <Button Content="本地回测"
                        Command="{Binding OpenBacktestCommand}"
                        Margin="0,0,8,0" />
                <Button Content="智能体决策模拟"
                        Command="{Binding RunAgentOnceCommand}"
                        Margin="0,0,8,0" />
                <Button Content="交易所连接自检"
                        Command="{Binding BinanceDiagnosticsCommand}"
                        Margin="0,0,8,0" />
                <Button Content="启动智能体循环"
                        Command="{Binding StartAgentLoopCommand}"
                        Margin="0,0,8,0" />
                <Button Content="停止智能体循环"
                        Command="{Binding StopAgentLoopCommand}"
                        Margin="0,0,8,0" />

                <!-- 新增：保存监控配置 -->
                <Button Content="保存监控配置"
                        Command="{Binding SaveWatchConfigCommand}"
                        Margin="16,0,0,0" />
                <!-- 新增：查看交易簿 -->
                <Button Content="查看交易簿"
                        Command="{Binding OpenTradeBookCommand}"
                        Margin="16,0,0,0" />
                <!-- 新增：分析/统计 -->
                <Button Content="分析/统计"
                        Command="{Binding OpenAnalyticsCommand}"
                        Margin="8,0,0,0" />
                <!-- 新增：策略设置按钮 -->
                <Button Content="策略设置..."
                        Margin="16,0,0,0"
                        Click="OnOpenStrategyConfigClick" />

                <!-- 风控状态面板 -->
                <StackPanel Orientation="Horizontal" Margin="16,0,0,0" VerticalAlignment="Center" DataContext="{Binding GlobalRiskStatus}">
                    <TextBlock Text="风控：" VerticalAlignment="Center" Margin="0,0,6,0" FontWeight="Bold" />
                    <TextBlock Text="{Binding RiskStateDisplay}" Margin="0,0,12,0" VerticalAlignment="Center" />
                    <TextBlock Text="{Binding TradesTodayDisplay}" Margin="0,0,12,0" VerticalAlignment="Center" />
                    <TextBlock Text="{Binding ConsecutiveLossDisplay}" Margin="0,0,12,0" VerticalAlignment="Center" />

                    <ToggleButton IsChecked="{Binding IsKillSwitchOn, Mode=TwoWay}"
                                  Command="{Binding ToggleKillSwitchCommand}"
                                  Content="暂停新开仓"
                                  VerticalAlignment="Center" />
                </StackPanel>

                <!-- DEBUG-only: Clear history DB -->
                <Button x:Name="ClearHistoryDbButton" Content="清空历史库（DEBUG）" Margin="16,0,0,0" Click="OnClearHistoryDbClick" Visibility="Collapsed" />
            </StackPanel>

            <!-- Row 1: Today's summary -->
            <StackPanel Grid.Row="1"
                        Orientation="Vertical"
                        Margin="8,4,8,4">
                <TextBlock Text="今日统计"
                           FontWeight="Bold"
                           Margin="0,0,0,4"/>

                <UniformGrid Columns="4">
                    <TextBlock Text="{Binding TodayTradeCount, StringFormat=今日成交笔数：{0}}" />
                    <TextBlock Text="{Binding TodayTotalPnl, StringFormat=今日总盈亏：{0:F2} USDT}" />
                    <TextBlock Text="{Binding TodayWinRate, StringFormat=今日胜率：{0:P1}}" />
                    <TextBlock Text="{Binding TodayMaxDrawdown, StringFormat=最大回撤：{0:F2} USDT}" />
                </UniformGrid>
            </StackPanel>

            <!-- Row 2: Symbol monitoring (left) + Binance positions/history (right) -->
            <Grid Grid.Row="2" Margin="16,0,16,8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="1.4*" />
                </Grid.ColumnDefinitions>

                <!-- Left: existing SymbolStatuses DataGrid -->
                <DataGrid Grid.Column="0"
                          ItemsSource="{Binding SymbolStatuses}"
                          AutoGenerateColumns="False"
                          IsReadOnly="False"
                          HeadersVisibility="Column"
                          Margin="0,0,12,0">
                    <DataGrid.Columns>
                        <DataGridCheckBoxColumn Header="启用" Binding="{Binding Enabled}" />
                        <DataGridTextColumn Header="交易对" Binding="{Binding Symbol}" />

                        <DataGridTemplateColumn Header="策略">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Strategy, Converter={StaticResource StrategyKindToDisplayConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                            <DataGridTemplateColumn.CellEditingTemplate>
                                <DataTemplate>
                                    <ComboBox
                                        ItemsSource="{Binding DataContext.AvailableStrategyKinds, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                        SelectedItem="{Binding Strategy, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" >
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource StrategyKindToDisplayConverter}}" />
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellEditingTemplate>
                        </DataGridTemplateColumn>

                        <DataGridTextColumn Header="持仓" Binding="{Binding PositionText}" />
                        <DataGridTextColumn Header="最近动作" Binding="{Binding LastAction}" />
                        <DataGridTextColumn Header="说明" Binding="{Binding LastExplanation}" />
                        <DataGridTextColumn Header="更新时间" Binding="{Binding LastUpdated, StringFormat=yyyy-MM-dd HH:mm:ss}" />
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Right: Binance current positions + history -->
                <Grid Grid.Column="1">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- GroupBox Header for Current Positions -->
                    <GroupBox Header="当前持仓（来自 Binance）" Margin="0,0,0,8">
                        <StackPanel>
                            <DockPanel>
                                <Button DockPanel.Dock="Right" Content="刷新持仓" Command="{Binding RefreshPositionsCommand}" Margin="6,0,0,0" />
                                <TextBlock Text="{Binding LastPositionsRefreshTime, StringFormat='最后刷新: {0:HH:mm:ss}'}" HorizontalAlignment="Right" Margin="0,0,4,0" />
                                <DataGrid ItemsSource="{Binding CurrentPositions}"
                                      AutoGenerateColumns="False"
                                      HeadersVisibility="Column"
                                      IsReadOnly="True"
                                      CanUserAddRows="False"
                                      Height="90">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="交易对" Binding="{Binding Symbol}" Width="*" />
                                        <DataGridTextColumn Header="方向" Binding="{Binding Side}" Width="80" />
                                        <DataGridTextColumn Header="数量(币)" Binding="{Binding Quantity}" Width="80" />
                                        <DataGridTextColumn Header="数量(USDT)" Binding="{Binding NotionalUsdt, StringFormat=F2}" Width="*" ElementStyle="{StaticResource RightAlignCellStyle}" />
                                        <DataGridTextColumn Header="开仓价" Binding="{Binding EntryPrice, StringFormat=F4}" Width="100" />
                                        <DataGridTextColumn Header="标记价" Binding="{Binding MarkPrice, StringFormat=F4}" Width="100" />
                                        <DataGridTextColumn Header="浮动盈亏(USDT)" Binding="{Binding UnrealizedPnlUsdt, StringFormat=F2}" Width="*" ElementStyle="{StaticResource RightAlignCellStyle}" />
                                        <DataGridTextColumn Header="开仓时间" Binding="{Binding EntryTime, StringFormat=yyyy-MM-dd HH:mm}" Width="140" />
                                    </DataGrid.Columns>
                                </DataGrid>
                            </DockPanel>

                            <TextBlock Text="当前在 Binance 上无持仓，或数据尚未同步，如有疑问请点击‘刷新持仓’查看。"
                                       Foreground="Gray"
                                       Margin="8,4,8,0"
                                       Visibility="{Binding ShowNoPositionsHint, Converter={StaticResource BooleanToVisibilityConverter}}" />
                        </StackPanel>
                    </GroupBox>

                    <GroupBox Grid.Row="1" Header="历史订单 / 历史成交（今日）">
                        <DockPanel>
                            <Button DockPanel.Dock="Top"
                                    Content="刷新"
                                    Command="{Binding RefreshTodayHistoryCommand}"
                                    Margin="0,0,0,6" />

                            <TabControl>
                                <TabItem Header="Trades">
                                    <DataGrid ItemsSource="{Binding TodayHistoryTrades}"
                                              AutoGenerateColumns="False"
                                              HeadersVisibility="Column"
                                              IsReadOnly="True"
                                              CanUserAddRows="False"
                                              ScrollViewer.VerticalScrollBarVisibility="Auto">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="时间" Binding="{Binding Time, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="150" />
                                            <DataGridTextColumn Header="交易对" Binding="{Binding Symbol}" Width="100" />
                                            <DataGridTextColumn Header="方向" Binding="{Binding Side}" Width="80" />
                                            <DataGridTextColumn Header="数量(币)" Binding="{Binding Quantity}" Width="80" ElementStyle="{StaticResource RightAlignCellStyle}" />
                                            <DataGridTextColumn Header="数量(USDT)" Binding="{Binding QuoteQty, StringFormat=F2}" Width="100" ElementStyle="{StaticResource RightAlignCellStyle}" />
                                            <DataGridTextColumn Header="开仓价" Binding="{Binding EntryPrice, StringFormat=F4}" Width="100" ElementStyle="{StaticResource RightAlignCellStyle}" />
                                            <DataGridTextColumn Header="平仓价" Binding="{Binding ExitPrice, StringFormat=F4}" Width="100" ElementStyle="{StaticResource RightAlignCellStyle}" />
                                            <DataGridTextColumn Header="已实现盈亏" Binding="{Binding RealizedPnl, StringFormat=F4}" Width="100" ElementStyle="{StaticResource RightAlignCellStyle}" />
                                            <DataGridTextColumn Header="手续费" Binding="{Binding Fee, StringFormat=F4}" Width="80" ElementStyle="{StaticResource RightAlignCellStyle}" />
                                        </DataGrid.Columns>
                                    </DataGrid>
                                </TabItem>

                                <TabItem Header="Orders">
                                    <DataGrid ItemsSource="{Binding TodayHistoryOrders}"
                                              AutoGenerateColumns="False"
                                              HeadersVisibility="Column"
                                              IsReadOnly="True"
                                              CanUserAddRows="False"
                                              ScrollViewer.VerticalScrollBarVisibility="Auto">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="创建时间" Binding="{Binding CreateTime, StringFormat=yyyy-MM-dd HH:mm:ss}" />
                                            <DataGridTextColumn Header="交易对" Binding="{Binding Symbol}" />
                                            <DataGridTextColumn Header="方向" Binding="{Binding Side}" />
                                            <DataGridTextColumn Header="类型" Binding="{Binding Type}" />
                                            <DataGridTextColumn Header="状态" Binding="{Binding Status}" />
                                            <DataGridTextColumn Header="价格" Binding="{Binding Price, StringFormat=F8}" />
                                            <DataGridTextColumn Header="数量" Binding="{Binding OrigQty, StringFormat=N8}" />
                                            <DataGridTextColumn Header="已成交" Binding="{Binding ExecutedQty, StringFormat=N8}" />
                                            <DataGridTextColumn Header="平均价" Binding="{Binding AvgPrice, StringFormat=F8}" />
                                            <DataGridTextColumn Header="StrategyId" Binding="{Binding StrategyId}" />
                                        </DataGrid.Columns>
                                    </DataGrid>
                                </TabItem>
                            </TabControl>
                        </DockPanel>
                    </GroupBox>
                </Grid>
            </Grid>

            <!-- Row 3: logs -->
            <TabControl Grid.Row="3" Margin="16,0,16,8">
                <TabItem Header="系统日志">
                    <ListBox ItemsSource="{Binding Logs}" />
                </TabItem>
                <TabItem Header="Agent 运行日志">
                    <DataGrid ItemsSource="{Binding AgentRunLogs}" AutoGenerateColumns="False" IsReadOnly="True">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="时间" Binding="{Binding Timestamp, StringFormat=yyyy-MM-dd HH:mm:ss}" />
                            <DataGridTextColumn Header="策略" Binding="{Binding StrategyId}" />
                            <DataGridTextColumn Header="Planned" Binding="{Binding PlannedOrders.Count}" />
                            <DataGridTextColumn Header="BlockedByRisk" Binding="{Binding BlockedByRisk.Count}" />
                            <DataGridTextColumn Header="Executed" Binding="{Binding ExecutedOrders.Count}" />
                        </DataGrid.Columns>
                    </DataGrid>
                </TabItem>
            </TabControl>
        </Grid>

    </DockPanel>
</Window>
